### Parquet: Columnar Storage for Hadoop

#### What is Parquet and columnar storage?

Parquet is an open-source columnar storage format for Hadoop. Its goal is to provide a state of the art columnar storage layer that can be taken advantage of by existing Hadoop frameworks, and can enable a new generation of Hadoop data processing architectures such as Impala, Drill, and parts of the Hive ‘Stinger’ initiative. Parquet does not tie its users to any existing processing framework or serialization library.

The idea behind columnar storage is simple: instead of storing millions of records row by row (employee name, employee age, employee address, employee salary…) store the records column by column (all the names, all the ages, all the addresses, all the salaries). This reorganization provides significant benefits for analytical processing:

Since all the values in a given column have the same type, generic compression tends to work better and type-specific compression can be applied.
Since column values are stored consecutively, a query engine can skip loading columns whose values it doesn’t need to answer a query, and use vectorized operators on the values it does load.
These effects combine to make columnar storage a very attractive option for analytical processing.

Implementing a columnar storage format that can be used by the many various Hadoop-based processing engines is tricky. Not all data people store in Hadoop is a simple table — complex nested structures abound. For example, one of Twitter’s common internal datasets has a schema nested seven levels deep, with over 80 leaf nodes. Slicing such objects into a columnar structure is non-trivial, and we chose to use the approach described by Google engineers in their paper **Dremel: Interactive Analysis of Web-Scale Datasets**. Another complexity derives from the fact that we want it to be relatively easy to plug new processing frameworks into Parquet. Despite these challenges, we are pleased with the results so far: our approach has resulted in integration with Hive, Pig, Cascading, Impala, and an in-progress implementation with Drill, and is currently in production at Twitter.

### Parquet Design

https://blog.twitter.com/2013/dremel-made-simple-with-parquet

### Using parquet-tools

For the rest of this tutorial, use parquet-tools to inspect a sample movies.parquet file.
You might need to refer to the built-in help: `parquet-tools --help`
Running a command with `-h` will print out help for using that command: `parquet-tools meta -h`

Use the hadoop command to copy the .parquet file to the local file system.
```
hadoop fs -copyToLocal /user/hive/warehouse/movies/72bc5d73-000f-4f16-ae03-fa14eeb74c38.parquet movies.parquet
```
##### Dump the file’s schema
```
parquet-tools schema sample.parquet
```
Produces:
```
message Movie {
  optional int64 id;
  optional binary title (UTF8);
  optional binary release_date (UTF8);
  optional binary video_release_date (UTF8);
  optional binary imdb_url (UTF8);
}
```

##### Find the file’s Avro schema

```
parquet-tools meta movies.parquet 
```
Produces:
```
creator:            parquet-mr (build 8e266e052e423af592871e2dfe09d54c03f6a0e8) 
extra:              avro.schema = {"type":"record","name":"Movie","doc":"Schema generated by Kite"," [more]...

file schema:        Movie 
--------------------------------------------------------------------------------------------------------------
id:                 OPTIONAL INT64 R:0 D:1
title:              OPTIONAL BINARY O:UTF8 R:0 D:1
release_date:       OPTIONAL BINARY O:UTF8 R:0 D:1
video_release_date: OPTIONAL BINARY O:UTF8 R:0 D:1
imdb_url:           OPTIONAL BINARY O:UTF8 R:0 D:1

row group 1:        RC:1682 TS:172459 
--------------------------------------------------------------------------------------------------------------
id:                  INT64 SNAPPY DO:0 FPO:4 SZ:7546/13508/1.79 VC:1682 ENC:PLAIN,RLE,BIT_PACKED
title:               BINARY SNAPPY DO:0 FPO:7550 SZ:30166/46293/1.53 VC:1682 ENC:PLAIN,RLE,BIT_PACKED
release_date:        BINARY SNAPPY DO:0 FPO:37716 SZ:3007/5332/1.77 VC:1682 ENC:RLE,PLAIN_DICTIONARY [more]...
video_release_date:  BINARY SNAPPY DO:0 FPO:40723 SZ:57/53/0.93 VC:1682 ENC:RLE,PLAIN_DICTIONARY,BIT_PACKED
imdb_url:            BINARY SNAPPY DO:0 FPO:40780 SZ:35344/107273/3.04 VC:1682 ENC:PLAIN,RLE,BIT_PACKED
```

##### Print the content of the file

```
parquet-tools cat movies.parquet
```
or 
```
parquet-tools head -n5 movies.parquet
```

##### Find the column with the best compression ratio
```
parquet-tools meta movies.parquet
```

Or use dump and suppress the data: `parquet-tools dump -d movies.parquet`

```
row group 0 
--------------------------------------------------------------------------------------------------------------
id:                  INT64 SNAPPY DO:0 FPO:4 SZ:7546/13508/1.79 VC:1682 ENC:BIT_PACKED,RLE,PLAIN
title:               BINARY SNAPPY DO:0 FPO:7550 SZ:30166/46293/1.53 VC:1682 ENC:BIT_PACKED,RLE,PLAIN
release_date:        BINARY SNAPPY DO:0 FPO:37716 SZ:3007/5332/1.77 VC:1682 ENC:BIT_PACKED,RLE,PLAIN [more]...
video_release_date:  BINARY SNAPPY DO:0 FPO:40723 SZ:57/53/0.93 VC:1682 ENC:BIT_PACKED,RLE,PLAIN_DICTIONARY
imdb_url:            BINARY SNAPPY DO:0 FPO:40780 SZ:35344/107273/3.04 VC:1682 ENC:BIT_PACKED,RLE,PLAIN

    id TV=1682 RL=0 DL=1
    ----------------------------------------------------------------------------------------------------------
    page 0:                                   DLE:RLE RLE:BIT_PACKED VLE:PLAIN SZ:13463 VC:1682

    title TV=1682 RL=0 DL=1
    ----------------------------------------------------------------------------------------------------------
    page 0:                                   DLE:RLE RLE:BIT_PACKED VLE:PLAIN SZ:46218 VC:1682

    release_date TV=1682 RL=0 DL=1 DS:       241 DE:PLAIN_DICTIONARY
    ----------------------------------------------------------------------------------------------------------
    page 0:                                   DLE:RLE RLE:BIT_PACKED VLE:PLAIN_DICTIONARY SZ:1675 VC:1682

    video_release_date TV=1682 RL=0 DL=1 DS: 1 DE:PLAIN_DICTIONARY
    ----------------------------------------------------------------------------------------------------------
    page 0:                                   DLE:RLE RLE:BIT_PACKED VLE:PLAIN_DICTIONARY SZ:10 VC:1682

    imdb_url TV=1682 RL=0 DL=1
    ----------------------------------------------------------------------------------------------------------
    page 0:                                   DLE:RLE RLE:BIT_PACKED VLE:PLAIN SZ:107183 VC:1682
```
